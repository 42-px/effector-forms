"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("effector"),r=require("effector-react");const o={store:function({init:r,domain:o,existing:t}){return t||(o?o.store(r):e.createStore(r))},event:function({domain:r,existing:o}){return o||(r?r.event():e.createEvent())}};function t(e,r,t){var i,n,s,u,l,a,d,c,m,f;const v="function"==typeof r.init?r.init():r.init,h=o.store({domain:t,existing:null===(i=r.units)||void 0===i?void 0:i.$value,init:v}),p=o.store({domain:t,existing:null===(n=r.units)||void 0===n?void 0:n.$errors,init:[]}),$=p.map(e=>e[0]?e[0]:null),g=h.map(e=>e!==v),x=o.store({domain:t,existing:null===(s=r.units)||void 0===s?void 0:s.$isTouched,init:!1}),E=o.event({domain:t,existing:null===(u=r.units)||void 0===u?void 0:u.onChange}),b=o.event({domain:t,existing:null===(l=r.units)||void 0===l?void 0:l.onBlur}),V=o.event({domain:t,existing:null===(a=r.units)||void 0===a?void 0:a.changed}),y=o.event({domain:t,existing:null===(d=r.units)||void 0===d?void 0:d.addError}),S=o.event({domain:t,existing:null===(c=r.units)||void 0===c?void 0:c.validate}),T=o.event({domain:t,existing:null===(m=r.units)||void 0===m?void 0:m.resetErrors}),F=o.event({domain:t,existing:null===(f=r.units)||void 0===f?void 0:f.reset});return{changed:V,name:e,$value:h,$errors:p,$firstError:$,$isValid:$.map(e=>null===e),$isDirty:g,$isTouched:x,$touched:x,onChange:E,onBlur:b,addError:y,validate:S,set:E,reset:F,resetErrors:T,filter:r.filter}}function i({$form:r,submitEvent:o,resetFormEvent:t,field:i,rules:n,formValidationEvents:s,fieldValidationEvents:u}){const{$value:l,$errors:a,onBlur:d,changed:c,addError:m,validate:f,resetErrors:v,reset:h}=i,p=e.combine(n.map(({source:r})=>r||e.createStore(null))),$=function(e){return(r,o,t)=>{const i=[];for(let n=0;n<e.length;n++){const s=e[n],u=t?t[n]:null,l=s.validator(r,o,u);"boolean"!=typeof l||l||i.push({rule:s.name,errorText:s.errorText,value:r}),"object"!=typeof l||l.isValid||i.push({rule:s.name,errorText:l.errorText,value:r})}return i}}(n),g=[...s,...u],x=[];g.includes("submit")&&x.push(e.sample({source:e.combine({fieldValue:l,form:r,rulesSources:p}),clock:o})),g.includes("blur")&&x.push(e.sample({source:e.combine({fieldValue:l,form:r,rulesSources:p}),clock:d})),g.includes("change")&&x.push(e.sample({source:e.combine({fieldValue:l,form:r,rulesSources:p}),clock:c})),x.push(e.sample({source:e.combine({fieldValue:l,form:r,rulesSources:p}),clock:f}));const E=e.sample({source:l,clock:m,fn:(e,{rule:r,errorText:o})=>({rule:r,value:e,errorText:o})});a.on(x,(e,{form:r,fieldValue:o,rulesSources:t})=>$(o,r,t)).on(E,(e,r)=>[r,...e]).reset(v,t,h),g.includes("change")||a.reset(c)}function n({$value:r,$touched:o,onChange:t,changed:i,name:n,reset:s,filter:u},l,a,d){o.on(i,()=>!0).reset(s,a,d),e.guard({source:t,filter:u||(()=>!0),target:i}),r.on(i,(e,r)=>r).on(l,(e,r)=>r.hasOwnProperty(n)?r[n]:e).reset(s,a)}function s(e){const o=r.useStore(e.$value),t=r.useStore(e.$errors),i=r.useStore(e.$firstError),n=r.useStore(e.$isValid),s=r.useStore(e.$isDirty),u=r.useStore(e.$touched);return{name:e.name,value:o,errors:t,firstError:i,isValid:n,isDirty:s,touched:u,isTouched:u,onChange:e.onChange,onBlur:e.onBlur,addError:e.addError,validate:e.validate,reset:e.reset,set:e.onChange,resetErrors:e.resetErrors,hasError:()=>null!==i,errorText:e=>i?e&&e[i.rule]?e[i.rule]:i.errorText||"":""}}exports.createForm=function(r){const{filter:s,domain:u,fields:l,validateOn:a,units:d}=r,c={},m=[],f=[];for(const e in l){if(!l.hasOwnProperty(e))continue;const r=t(e,l[e],u);c[e]=r,m.push(r.$isDirty),f.push(r.$touched)}const v=function(r){const o={};for(const e in r)r.hasOwnProperty(e)&&(o[e]=r[e].$value);return e.combine(o)}(c),h=function(r){const o=[];for(const e in r){if(!r.hasOwnProperty(e))continue;const{$firstError:t}=r[e];o.push(t)}return e.combine(o).map(e=>e.every(e=>null===e))}(c),p=s?e.combine(h,s,(e,r)=>e&&r):h,$=e.combine(m).map(e=>e.some(Boolean)),g=e.combine(f).map(e=>e.some(Boolean)),x=o.event({domain:u,existing:null==d?void 0:d.submit}),E=o.event({domain:u,existing:null==d?void 0:d.formValidated}),b=o.event({domain:u,existing:null==d?void 0:d.setForm}),V=o.event({domain:u,existing:null==d?void 0:d.reset}),y=o.event({domain:u,existing:null==d?void 0:d.resetTouched}),S=e.sample(v,x);for(const e in c){if(!c.hasOwnProperty(e))continue;const r=l[e],o=c[e];n(o,b,V,y),r.rules&&i({$form:v,rules:r.rules,submitEvent:x,resetFormEvent:V,field:o,formValidationEvents:a||["submit"],fieldValidationEvents:r.validateOn?r.validateOn:[]})}return e.guard({source:S,filter:p,target:E}),{fields:c,$values:v,$eachValid:h,$isValid:h,$isDirty:$,$touched:g,submit:x,resetTouched:y,reset:V,setForm:b,set:b,formValidated:E}},exports.useField=s,exports.useForm=function(e){const o={};for(const r in e.fields){if(!e.fields.hasOwnProperty(r))continue;const t=e.fields[r];o[r]=s(t)}const t=r.useStore(e.$values),i=r.useStore(e.$eachValid),n=r.useStore(e.$isDirty),u=r.useStore(e.$touched);return{fields:o,values:t,hasError:e=>e?!!o[e]&&Boolean(o[e].firstError):!i,eachValid:i,isValid:i,isDirty:n,isTouched:u,touched:u,errors:e=>o[e]?o[e].errors:[],error:e=>o[e]?o[e].firstError:null,reset:e.reset,errorText:(e,r)=>{const t=o[e];return t&&t.firstError?r&&r[t.firstError.rule]?r[t.firstError.rule]:t.firstError.errorText||"":""},submit:e.submit,setForm:e.setForm,set:e.setForm,formValidated:e.formValidated}};
//# sourceMappingURL=effector-forms.cjs.js.map
