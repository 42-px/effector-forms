"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("effector"),r=require("effector-react");const t={store:function({init:r,domain:t,existing:o}){return o||(t?t.store(r):e.createStore(r))},event:function({domain:r,existing:t}){return t||(r?r.event():e.createEvent())}};function o(r,o,i){var n,s,l,u,a,d,c,m,v,f,h;const g="function"==typeof o.init?o.init():o.init,p=t.store({domain:i,existing:null===(n=o.units)||void 0===n?void 0:n.$value,init:g}),E=t.store({domain:i,existing:null===(s=o.units)||void 0===s?void 0:s.$errors,init:[]}),x=E.map(e=>e[0]?e[0]:null),V=p.map(e=>e!==g),$=t.store({domain:i,existing:null===(l=o.units)||void 0===l?void 0:l.$isTouched,init:!1}),b=t.event({domain:i,existing:null===(u=o.units)||void 0===u?void 0:u.onChange}),y=t.event({domain:i,existing:null===(a=o.units)||void 0===a?void 0:a.onBlur}),T=t.event({domain:i,existing:null===(d=o.units)||void 0===d?void 0:d.changed}),F=t.event({domain:i,existing:null===(c=o.units)||void 0===c?void 0:c.addError}),S=t.event({domain:i,existing:null===(m=o.units)||void 0===m?void 0:m.validate}),O=t.event({domain:i,existing:null===(v=o.units)||void 0===v?void 0:v.resetErrors}),D=t.event({domain:i,existing:null===(f=o.units)||void 0===f?void 0:f.resetValue}),B=t.event({domain:i,existing:null===(h=o.units)||void 0===h?void 0:h.reset}),P=x.map(e=>null===e);return{changed:T,name:r,$value:p,$errors:E,$firstError:x,$isValid:P,$isDirty:V,$isTouched:$,$touched:$,$field:e.combine({value:p,errors:E,firstError:x,isValid:P,isDirty:V,isTouched:$}),onChange:b,onBlur:y,addError:F,validate:S,set:b,reset:B,resetErrors:O,resetValue:D,filter:o.filter}}function i({$form:r,validateFormEvent:t,submitEvent:o,resetFormEvent:i,resetValues:n,field:s,rules:l,resetErrors:u,formValidationEvents:a,fieldValidationEvents:d}){const{$value:c,$errors:m,onBlur:v,changed:f,addError:h,validate:g,resetErrors:p,resetValue:E,reset:x}=s,V="function"==typeof l?e.createStore([]):e.combine(l.map(({source:r})=>r||e.createStore(null))),$=(b=l,(e,r,t)=>{const o=[],i="function"==typeof b?b(e,r):b;for(let n=0;n<i.length;n++){const s=i[n],l=t?t[n]:null,u=s.validator(e,r,l);"boolean"!=typeof u||u||o.push({rule:s.name,errorText:s.errorText,value:e}),"object"!=typeof u||u.isValid||o.push({rule:s.name,errorText:u.errorText,value:e})}return o});var b;const y=[...a,...d],T=[];if(y.includes("submit")){const t=e.sample({source:e.combine({fieldValue:c,form:r,rulesSources:V}),clock:o});T.push(t)}y.includes("blur")&&T.push(e.sample({source:e.combine({fieldValue:c,form:r,rulesSources:V}),clock:v})),y.includes("change")&&T.push(e.sample({source:e.combine({fieldValue:c,form:r,rulesSources:V}),clock:e.merge([f,E,n])})),T.push(e.sample({source:e.combine({fieldValue:c,form:r,rulesSources:V}),clock:g})),T.push(e.sample({source:e.combine({fieldValue:c,form:r,rulesSources:V}),clock:t}));const F=e.sample({source:c,clock:h,fn:(e,{rule:r,errorText:t})=>({rule:r,value:e,errorText:t})});m.on(T,(e,{form:r,fieldValue:t,rulesSources:o})=>$(t,r,o)).on(F,(e,r)=>[r,...e]).reset(p,i,x,u),y.includes("change")||m.reset(f)}function n({$value:r,$touched:t,onChange:o,changed:i,name:n,reset:s,resetValue:l,filter:u},a,d,c,m){t.on(i,()=>!0).reset(s,d,c),e.guard({source:o,filter:u||(()=>!0),target:i}),r.on(i,(e,r)=>r).on(a,(e,r)=>r.hasOwnProperty(n)?r[n]:e).reset(s,l,m,d)}function s(e){const{value:t,errors:o,firstError:i,isValid:n,isDirty:s,isTouched:l}=r.useStore(e.$field);return{name:e.name,value:t,errors:o,firstError:i,isValid:n,isDirty:s,touched:l,isTouched:l,onChange:e.onChange,onBlur:e.onBlur,addError:e.addError,validate:e.validate,reset:e.reset,set:e.onChange,resetErrors:e.resetErrors,hasError:()=>null!==i,errorText:e=>i?e&&e[i.rule]?e[i.rule]:i.errorText||"":""}}exports.createForm=function(r){const{filter:s,domain:l,fields:u,validateOn:a,units:d}=r,c={},m=[],v=[];for(const e in u){if(!u.hasOwnProperty(e))continue;const r=o(e,u[e],l);c[e]=r,m.push(r.$isDirty),v.push(r.$touched)}const f=function(r){const t={};for(const e in r)r.hasOwnProperty(e)&&(t[e]=r[e].$value);return e.combine(t)}(c),h=function(r){const t=[];for(const e in r){if(!r.hasOwnProperty(e))continue;const{$firstError:o}=r[e];t.push(o)}return e.combine(t).map(e=>e.every(e=>null===e))}(c),g=s?e.combine(h,s,(e,r)=>e&&r):h,p=e.combine(m).map(e=>e.some(Boolean)),E=e.combine(v).map(e=>e.some(Boolean)),x=e.combine({isValid:h,isDirty:p,touched:E}),V=t.event({domain:l,existing:null==d?void 0:d.validate}),$=t.event({domain:l,existing:null==d?void 0:d.submit}),b=t.event({domain:l,existing:null==d?void 0:d.formValidated}),y=t.event({domain:l,existing:null==d?void 0:d.setForm}),T=t.event({domain:l,existing:null==d?void 0:d.reset}),F=t.event({domain:l,existing:null==d?void 0:d.resetValues}),S=t.event({domain:l,existing:null==d?void 0:d.resetErrors}),O=t.event({domain:l,existing:null==d?void 0:d.resetTouched}),D=e.sample(f,$),B=e.sample(f,V);for(const e in c){if(!c.hasOwnProperty(e))continue;const r=u[e],t=c[e];n(t,y,T,O,F),r.rules&&i({$form:f,rules:r.rules,submitEvent:$,resetFormEvent:T,resetValues:F,resetErrors:S,validateFormEvent:V,field:t,formValidationEvents:a||["submit"],fieldValidationEvents:r.validateOn?r.validateOn:[]})}return e.guard({source:D,filter:g,target:b}),e.guard({source:B,filter:g,target:b}),{fields:c,$values:f,$eachValid:h,$isValid:h,$isDirty:p,$touched:E,$meta:x,submit:$,validate:V,resetTouched:O,reset:T,resetValues:F,resetErrors:S,setForm:y,set:y,formValidated:b}},exports.useField=s,exports.useForm=function(e){const t={},o={};for(const r in e.fields){if(!e.fields.hasOwnProperty(r))continue;const i=s(e.fields[r]);t[r]=i,o[r]=i.value}const{isValid:i,isDirty:n,touched:l}=r.useStore(e.$meta);return{fields:t,values:o,hasError:e=>e?!!t[e]&&Boolean(t[e].firstError):!i,eachValid:i,isValid:i,isDirty:n,isTouched:l,touched:l,errors:e=>t[e]?t[e].errors:[],error:e=>t[e]?t[e].firstError:null,reset:e.reset,errorText:(e,r)=>{const o=t[e];return o&&o.firstError?r&&r[o.firstError.rule]?r[o.firstError.rule]:o.firstError.errorText||"":""},submit:e.submit,setForm:e.setForm,set:e.setForm,formValidated:e.formValidated}};
//# sourceMappingURL=effector-forms.cjs.js.map
