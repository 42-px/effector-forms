"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("effector"),r=require("effector-react");const t={store:function({init:r,domain:t,existing:o}){return o||(t?t.store(r):e.createStore(r))},event:function({domain:r,existing:t}){return t||(r?r.event():e.createEvent())}};function o(e,r,o){const n="function"==typeof r.init?r.init():r.init,i=t.store({domain:o,existing:r.units?.$value,init:n}),s=t.store({domain:o,existing:r.units?.$errors,init:[]}),u=s.map(e=>e[0]?e[0]:null),a=i.map(e=>e!==n),l=t.store({domain:o,existing:r.units?.$isTouched,init:!1}),c=t.event({domain:o,existing:r.units?.onChange}),d=t.event({domain:o,existing:r.units?.onBlur}),m=t.event({domain:o,existing:r.units?.changed}),f=t.event({domain:o,existing:r.units?.addError}),v=t.event({domain:o,existing:r.units?.validate}),h=t.event({domain:o,existing:r.units?.resetErrors}),p=t.event({domain:o,existing:r.units?.reset});return{changed:m,name:e,$value:i,$errors:s,$firstError:u,$isValid:u.map(e=>null===e),$isDirty:a,$isTouched:l,$touched:l,onChange:c,onBlur:d,addError:f,validate:v,set:c,reset:p,resetErrors:h,filter:r.filter}}function n({$form:r,submitEvent:t,resetFormEvent:o,field:n,rules:i,formValidationEvents:s,fieldValidationEvents:u}){const{$value:a,$errors:l,onBlur:c,changed:d,addError:m,validate:f,resetErrors:v,reset:h}=n,p=function(e){return(r,t)=>{const o=[];for(const n of e){const e=n.validator(r,t);"boolean"!=typeof e||e||o.push({rule:n.name,errorText:n.errorText,value:r}),"object"!=typeof e||e.isValid||o.push({rule:n.name,errorText:e.errorText,value:r})}return o}}(i),$=[...s,...u],g=[];$.includes("submit")&&g.push(e.sample({source:e.combine({fieldValue:a,form:r}),clock:t})),$.includes("blur")&&g.push(e.sample({source:e.combine({fieldValue:a,form:r}),clock:c})),$.includes("change")&&g.push(e.sample({source:e.combine({fieldValue:a,form:r}),clock:d})),g.push(e.sample({source:e.combine({fieldValue:a,form:r}),clock:f}));const x=e.sample({source:a,clock:m,fn:(e,{rule:r,errorText:t})=>({rule:r,value:e,errorText:t})});l.on(g,(e,{form:r,fieldValue:t})=>p(t,r)).on(x,(e,r)=>[r,...e]).reset(v,o,h),$.includes("change")||l.reset(d)}function i({$value:r,$touched:t,onChange:o,changed:n,name:i,reset:s,filter:u},a,l,c){t.on(n,()=>!0).reset(s,l,c),e.guard({source:o,filter:u||(()=>!0),target:n}),r.on(n,(e,r)=>r).on(a,(e,r)=>r.hasOwnProperty(i)?r[i]:e).reset(s,l)}function s(e){const t=r.useStore(e.$value),o=r.useStore(e.$errors),n=r.useStore(e.$firstError),i=r.useStore(e.$isValid),s=r.useStore(e.$isDirty),u=r.useStore(e.$touched);return{name:e.name,value:t,errors:o,firstError:n,isValid:i,isDirty:s,touched:u,isTouched:u,onChange:e.onChange,onBlur:e.onBlur,addError:e.addError,validate:e.validate,reset:e.reset,set:e.onChange,resetErrors:e.resetErrors,hasError:()=>null!==n,errorText:e=>n?e&&e[n.rule]?e[n.rule]:n.errorText||"":""}}exports.createForm=function(r){const{filter:s,domain:u,fields:a,validateOn:l,units:c}=r,d={},m=[],f=[];for(const e in a){if(!a.hasOwnProperty(e))continue;const r=o(e,a[e],u);d[e]=r,m.push(r.$isDirty),f.push(r.$touched)}const v=function(r){const t={};for(const e in r)r.hasOwnProperty(e)&&(t[e]=r[e].$value);return e.combine(t)}(d),h=function(r){const t=[];for(const e in r){if(!r.hasOwnProperty(e))continue;const{$firstError:o}=r[e];t.push(o)}return e.combine(t).map(e=>e.every(e=>null===e))}(d),p=s?e.combine(h,s,(e,r)=>e&&r):h,$=e.combine(m).map(e=>e.some(Boolean)),g=e.combine(f).map(e=>e.some(Boolean)),x=t.event({domain:u,existing:c?.submit}),E=t.event({domain:u,existing:c?.formValidated}),V=t.event({domain:u,existing:c?.setForm}),b=t.event({domain:u,existing:c?.reset}),y=t.event({domain:u,existing:c?.resetTouched}),T=e.sample(v,x);for(const e in d){if(!d.hasOwnProperty(e))continue;const r=a[e],t=d[e];i(t,V,b,y),r.rules&&n({$form:v,rules:r.rules,submitEvent:x,resetFormEvent:b,field:t,formValidationEvents:l||["submit"],fieldValidationEvents:r.validateOn?r.validateOn:[]})}return e.guard({source:T,filter:p,target:E}),{fields:d,$values:v,$eachValid:h,$isValid:h,$isDirty:$,$touched:g,submit:x,resetTouched:y,reset:b,setForm:V,set:V,formValidated:E}},exports.useField=s,exports.useForm=function(e){const t={};for(const r in e.fields){if(!e.fields.hasOwnProperty(r))continue;const o=e.fields[r];t[r]=s(o)}const o=r.useStore(e.$values),n=r.useStore(e.$eachValid),i=r.useStore(e.$isDirty),u=r.useStore(e.$touched);return{fields:t,values:o,hasError:e=>e?!!t[e]&&Boolean(t[e].firstError):!n,eachValid:n,isValid:n,isDirty:i,isTouched:u,touched:u,errors:e=>t[e]?t[e].errors:[],error:e=>t[e]?t[e].firstError:null,reset:e.reset,errorText:(e,r)=>{const o=t[e];return o&&o.firstError?r&&r[o.firstError.rule]?r[o.firstError.rule]:o.firstError.errorText||"":""},submit:e.submit,setForm:e.setForm,set:e.setForm,formValidated:e.formValidated}};
//# sourceMappingURL=effector-forms.cjs.js.map
